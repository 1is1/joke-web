<!doctype html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <title>Joke Web Builder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --sidebar-width: 320px;
      --sidebar-collapsed-width: 10px;
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      display: flex;
      height: 100vh;
    }
    .sidebar {
      width: var(--sidebar-width);
      border-right: 1px solid #ddd;
      padding: 1rem;
      box-sizing: border-box;
      background: #f8f8f8;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      overflow-y: auto;
      transition: width .0s ease-out, padding .0s ease-out;
      position: relative;
    }
    .sidebar.collapsed {
      width: var(--sidebar-collapsed-width);
      padding: .5rem .4rem;
      overflow: visible;
    }
    .sidebar h2 {
      margin: 0;
      font-size: 1.1rem;
      transition: opacity .15s ease-out;
    }
    .sidebar.collapsed h2,
    .sidebar.collapsed .hide-when-collapsed {
      opacity: 0;
      pointer-events: none;
      height: 0;
      margin: 0;
      padding: 0;
    }
    .collapse-btn {
      position: absolute;
      top: .5rem;
      left: .5rem;
      width: 26px;
      height: 26px;
      border: 1px solid #ccc;
      border-radius: 6px;
      background: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: .8rem;
      margin:5px;
    }
    .web-list {
      border: 1px solid #ddd;
      background: #fff;
      border-radius: 6px;
      padding: .5rem;
      max-height: 180px;
      overflow-y: auto;
      margin-bottom: 4px;
    }
    .web-item {
      padding: .2rem .3rem;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      gap: .5rem;
      align-items: center;
      white-space: nowrap;
    }
    .web-item.active {
      background: #e0ecff;
    }
    .web-item button {
      border: none;
      background: none;
      color: #aaa;
      cursor: pointer;
    }
    .input-row {
      display: flex;
      gap: .5rem;
    }
    input[type="text"] {
      flex: 1;
      padding: .4rem .5rem;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    button {
      cursor: pointer;
      border-radius: 4px;
      border: 1px solid #ccc;
      background: #fff;
      padding: .35rem .7rem;
    }
    button.primary {
      background: #2563eb;
      color: #fff;
      border-color: #2563eb;
    }
    .plus-btn {
      width: 34px;
      text-align: center;
      font-weight: 600;
      padding: .35rem 0;
    }
    .main {
      flex: 1;
      position: relative;
      background: #ffffff;
      overflow: hidden;
    }
    .center-node {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #2563eb;
      color: white;
      padding: .6rem 1.2rem;
      border-radius: 999px;
      font-weight: 600;
      text-align: center;
      min-width: 120px;
    }
    .assoc-node {
      position: absolute;
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      border-radius: 999px;
      padding: .35rem .75rem;
      white-space: nowrap;
      cursor: pointer;
      transition: transform .0s ease-out;
    }

    .assoc-node .assoc-delete {
      position: absolute;
      top: -6px;
      right: -6px;
      width: 15px;
      height: 15px;
      border-radius: 999px;
      background: #b91c1c;
      color: #fff;
      font-size: 10px;
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,.2);
    }

    .assoc-node:hover .assoc-delete {
      display: flex;
    }

    .assoc-node:hover {
      transform: scale(1.06);
      background: #e5e7eb;
    }
    .bottom-bar {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      padding: .6rem 1rem;
      display: flex;
      gap: .5rem;
      align-items: center;
      justify-content: center;
      font-size: .75rem;
    }
    .tip-box {
      display: flex;
      gap: .5rem;
      align-items: center;
      color: #374151;
      background: #f3f4f6;
      padding: 5px;
      border-radius: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,.2);
    }
    .tip-pill {
      background: #e0ecff;
      color: #1f2937;
      padding: .2rem .55rem;
      border-radius: 999px;
      font-size: .65rem;
      font-weight: 600;
    }
    #exportOutput {
      width: 100%;
      height: 140px;
      box-sizing: border-box;
      display: none;
    }
    select {
      width: 100%;
      padding: .35rem .4rem;
      border-radius: 4px;
      border: 1px solid #ccc;
      background: #fff;
    }
    .assoc-floating {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      top: 85%;
      background: rgba(248, 248, 248, .9);
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: .55rem .65rem;
      display: flex;
      gap: .4rem;
      align-items: center;
      box-shadow: 0 8px 12px rgba(0,0,0,.05);
    }
    .assoc-floating input {
      width: 260px;
      padding: .4rem .45rem;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: .9rem;
    }
    /* suggestions box */
    .suggestions {
      background: #f1f2f3;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: .5rem .6rem;
      font-size: .72rem;
      color: #4b5563;
      line-height: 1.35;
    }
    .suggestions-title {
      font-weight: 600;
      margin-bottom: .25rem;
      font-size: .75rem;
    }
    .delete-all-btn {
      background: #fff;
      border: 1px solid #f0b4b4;
      color: #b91c1c;
      font-size: .7rem;
      padding: .25rem .4rem;
      border-radius: 4px;
      margin-top: .25rem;
    }

    /* collapsed-specific hiding */
    .sidebar.collapsed .web-list,
    .sidebar.collapsed .input-row,
    .sidebar.collapsed .section-title,
    .sidebar.collapsed .suggestions,
    .sidebar.collapsed #reflectSelect,
    .sidebar.collapsed #exportBtn,
    .sidebar.collapsed #exportOutput,
    .sidebar.collapsed .delete-all-btn {
      display: none !important;
    }

    .back-to-overview {
      position: fixed;
      top: 1rem;
      right: 1rem;
      background: #ffffff;
      border: 1px solid rgba(15,23,42,.05);
      border-radius: 999px;
      padding: .35rem .75rem .4rem;
      font-size: .63rem;
      color: #0f172a;
      text-decoration: none;
      display: inline-flex;
      gap: .25rem;
      align-items: center;
      box-shadow: 0 10px 28px rgba(15,23,42,.08);
      z-index: 1000;
    }
    .back-to-overview:hover {
      background: #f8fafc;
    }

  </style>
</head>
<body>
  <div class="sidebar" id="sidebar">
    
    <div class="hide-when-collapsed">
      <h2>Joke webs</h2>
      <div class="web-list" id="webList" style="display:none;"></div>
      <div class="input-row">
        <input type="text" id="newRootInput" placeholder="Nyt hovedemne (fx Jul)" />
        <button class="primary plus-btn" id="addRootBtn">+</button>
      </div>
    </div>

    <div class="hide-when-collapsed">
      <div class="section-title">Vis andet emne i midten</div>
      <select id="reflectSelect" style="display:none;"></select>
    </div>

    <div class="hide-when-collapsed">
      <div class="section-title">Eksporter til markdown</div>
      <button id="exportBtn">Eksporter</button>
      <textarea id="exportOutput"></textarea>
    </div>

    <div class="hide-when-collapsed">
      <div class="section-title">Gode råd til Joke Webs</div>
      <div class="suggestions">
        <div class="suggestions-title">Tips</div>
        <ul style="padding-left:1rem; margin:0;">
          <li>Associer bredt – men husk også at få de oplagte med. (i.e. "Hospital" skal helst ikke tømmes ud uden at "Læge" bringes op)</li>
          <li>Se hvert joke web som en ny start. (i.e. hvis du er gået fra "Jul" til "Gaver", så bør "Tre vise mænd" ikke komme først) </li>
          <li>Vælg afledte emner, der hverken er for tætte på oprindelsesemnet eller for langt væk. (i.e. hvis du vælger for nærtliggende et associationsemne så er der for stort et overlap og hvis associationsemnet er for fjernt, så kan det være svært for andre at følge med.) </li>
        </ul>
      </div>
      <span style="font-size:.65rem; display:block; color:#6b7280;">Data gemmes lokalt i din browser.</span>
      <button class="delete-all-btn" id="deleteAllBtn">Slet al hukommelse</button>
    </div>
  </div>

  <div class="main" id="mainArea">
    <a href="https://1is1.github.io/joke-tools/" class="back-to-overview">← Til oversigt</a>
    <button class="collapse-btn" id="collapseBtn">◀</button>
    <div class="bottom-bar">
      <div class="tip-box">
        <span class="tip-pill">TIP</span>
        <span>Klik på en boble for at starte et nyt joke web på det emne.</span>
      </div>
    </div>

    <!-- centered association input -->
    <div class="assoc-floating" id="assocInputBox">
      <input type="text" id="newAssocInput" placeholder="Ny association..." />
    </div>
  </div>
  

  <script>
    const STORAGE_KEY = "joke-web-data";
    const RING_CONFIG = [
      { radius: 140, capacity: 8 },
      { radius: 220, capacity: 12 },
      { radius: 300, capacity: 16 }
    ];

    const stored = loadFromStorage();
    let webs = stored.webs;
    let selectedWebId = stored.selectedWebId;
    let visualizedWebId = stored.visualizedWebId;
    let centerOverrideId = stored.centerOverrideId;

    const webListEl = document.getElementById('webList');
    const mainArea = document.getElementById('mainArea');
    const newRootInput = document.getElementById('newRootInput');
    const newAssocInput = document.getElementById('newAssocInput');
    const exportOutput = document.getElementById('exportOutput');
    const reflectSelect = document.getElementById('reflectSelect');
    const addRootBtn = document.getElementById('addRootBtn');
    const assocInputBox = document.getElementById('assocInputBox');
    const sidebar = document.getElementById('sidebar');
    const collapseBtn = document.getElementById('collapseBtn');
    const deleteAllBtn = document.getElementById('deleteAllBtn');

    // collapse toggle
    collapseBtn.addEventListener('click', () => {
      sidebar.classList.toggle('collapsed');
      collapseBtn.textContent = sidebar.classList.contains('collapsed') ? '▶' : '◀';
      renderWeb();
    });

    // delete all memory
    deleteAllBtn.addEventListener('click', () => {
      const ok = confirm("Er du sikker på, at du vil slette alle joke webs?\nDette kan ikke fortrydes.");
      if (ok) {
        localStorage.removeItem(STORAGE_KEY);
        location.reload();
      }
    });

    // new web: enter
    newRootInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        createNewWeb();
      }
    });
    addRootBtn.addEventListener('click', () => {
      createNewWeb();
    });

    function createNewWeb() {
      const title = newRootInput.value.trim();
      if (!title) return;
      const newWeb = {
        id: makeId(),
        title,
        associations: [],
        derivedFrom: null
      };
      webs.push(newWeb);
      selectedWebId = newWeb.id;
      visualizedWebId = newWeb.id;
      centerOverrideId = null;
      newRootInput.value = '';
      saveToStorage();
      renderAll();
    }

    // add association via enter
    newAssocInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        addAssoc();
      }
    });

    document.getElementById('exportBtn').addEventListener('click', () => {
      exportOutput.value = generateMarkdown(webs);
      exportOutput.style.display = 'block';
    });

    reflectSelect.addEventListener('change', () => {
      const chosenId = reflectSelect.value;
      if (chosenId === 'none') {
        centerOverrideId = null;
      } else {
        centerOverrideId = chosenId;
      }
      renderWeb();
    });

    function addAssoc() {
      const assoc = newAssocInput.value.trim();
      if (!assoc || !selectedWebId) return;
      const web = getWebById(selectedWebId);
      web.associations.push(assoc);
      newAssocInput.value = '';
      saveToStorage();
      renderWeb();
    }

    function removeAssociationFromWeb(webId, index) {
      const w = getWebById(webId);
      if (!w) return;
      w.associations.splice(index, 1);
      saveToStorage();
      renderAll();
    }

    function renderAll() {
      renderSidebar();
      renderReflectDropdown();
      renderWeb();
    }

    function renderSidebar() {
      if (!webs.length) {
        webListEl.style.display = 'none';
      } else {
        webListEl.style.display = 'block';
      }

      webListEl.innerHTML = '';

      const roots = webs.filter(w => !w.derivedFrom);
      const byParent = {};
      webs.forEach(w => {
        if (w.derivedFrom) {
          if (!byParent[w.derivedFrom]) byParent[w.derivedFrom] = [];
          byParent[w.derivedFrom].push(w);
        }
      });

      roots.forEach(root => {
        appendWebListItem(root, 0, byParent);
      });
    }

    function appendWebListItem(web, level, byParent) {
      const item = document.createElement('div');
      item.className = 'web-item' + (web.id === selectedWebId ? ' active' : '');
      item.addEventListener('click', () => {
        selectedWebId = web.id;
        visualizedWebId = web.id;
        centerOverrideId = null;
        saveToStorage();
        renderAll();
      });

      const span = document.createElement('span');
      span.textContent = '  '.repeat(level) + web.title;
      span.style.whiteSpace = 'pre';

      const delBtn = document.createElement('button');
      delBtn.textContent = '✕';
      delBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        deleteWeb(web.id);
      });

      item.appendChild(span);
      item.appendChild(delBtn);
      webListEl.appendChild(item);

      const children = byParent[web.id];
      if (children && children.length) {
        children.forEach(ch => appendWebListItem(ch, level + 1, byParent));
      }
    }

    function renderReflectDropdown() {
      if (!webs.length || !selectedWebId) {
        reflectSelect.style.display = 'none';
        return;
      }
      reflectSelect.style.display = 'block';
      reflectSelect.innerHTML = '';
      const optNone = document.createElement('option');
      optNone.value = 'none';
      optNone.textContent = 'Nej';
      reflectSelect.appendChild(optNone);

      webs.forEach(w => {
        const opt = document.createElement('option');
        opt.value = w.id;
        opt.textContent = w.title;
        reflectSelect.appendChild(opt);
      });

      if (centerOverrideId) {
        reflectSelect.value = centerOverrideId;
      } else {
        reflectSelect.value = 'none';
      }
    }

    function renderWeb() {
      mainArea.querySelectorAll('.center-node, .assoc-node').forEach(el => el.remove());
      if (!visualizedWebId) return;
      const web = getWebById(visualizedWebId);
      if (!web) return;

      // center-tekst (evt. overridet)
      let centerTitle = web.title;
      if (centerOverrideId) {
        const overrideWeb = getWebById(centerOverrideId);
        if (overrideWeb) {
          centerTitle = overrideWeb.title;
        }
      }

      // lav center
      const center = document.createElement('div');
      center.className = 'center-node';
      center.textContent = centerTitle;
      mainArea.appendChild(center);

      const mainRect = mainArea.getBoundingClientRect();
      const centerX = mainRect.width / 2;
      const centerY = mainRect.height / 2;
      const bottomReserved = 50;
      const margin = 8;
      const assocInputRect = assocInputBox.getBoundingClientRect();

      // gem allerede placerede bobler
      const placed = [];

      web.associations.forEach((assocTitle, idx) => {
        // 1) find ring + index
        let ringIndex = 0;
        let indexWithinRing = idx;
        for (let r = 0; r < RING_CONFIG.length; r++) {
          const cap = RING_CONFIG[r].capacity;
          if (indexWithinRing < cap) {
            ringIndex = r;
            break;
          } else {
            indexWithinRing -= cap;
          }
        }
        const ring = RING_CONFIG[Math.min(ringIndex, RING_CONFIG.length - 1)];
        const totalInThisRing = ring.capacity;
        const angle = (2 * Math.PI * indexWithinRing) / totalInThisRing;

        // 2) ideal position
        const idealX = centerX + ring.radius * Math.cos(angle);
        const idealY = centerY + ring.radius * Math.sin(angle);

        // 3) lav boblen
        const assocEl = document.createElement('div');
        assocEl.className = 'assoc-node';
        const derived = webs.find(w => w.title.toLowerCase() === assocTitle.toLowerCase());
        assocEl.textContent = assocTitle + (derived ? ' *' : '');
        mainArea.appendChild(assocEl);

        // 3b) lav delete-knap
        const del = document.createElement('div');
        del.className = 'assoc-delete';
        del.textContent = '–';
        del.addEventListener('click', (e) => {
          e.stopPropagation(); // så vi ikke åbner/navigerer
          removeAssociationFromWeb(web.id, idx);
        });
        assocEl.appendChild(del);

        // 4) mål
        const elRect = assocEl.getBoundingClientRect();
        const w = elRect.width;
        const h = elRect.height;

        // 5) udgangspunkt
        let finalLeft = idealX - w / 2;
        let finalTop = idealY - h / 2;

        // 6) clamp til canvas
        if (finalLeft < margin) finalLeft = margin;
        if (finalTop < margin) finalTop = margin;
        if (finalLeft + w > mainRect.width - margin) {
          finalLeft = mainRect.width - margin - w;
        }
        if (finalTop + h > mainRect.height - margin - bottomReserved) {
          finalTop = mainRect.height - margin - bottomReserved - h;
        }

        // 7) undgå input-boks
        const inputLeft = assocInputRect.left - mainRect.left;
        const inputTop = assocInputRect.top - mainRect.top;
        const inputRight = inputLeft + assocInputRect.width;
        const inputBottom = inputTop + assocInputRect.height;

        const overlapsInput =
          !(finalLeft + w < inputLeft ||
            finalLeft > inputRight ||
            finalTop + h < inputTop ||
            finalTop > inputBottom);

        if (overlapsInput) {
          finalTop = inputTop - h - 8;
          if (finalTop < margin) finalTop = margin;
        }

        // 8) collision resolve mod tidligere
        const box = { x: finalLeft, y: finalTop, w, h };
        resolveCollisions(box, placed, centerX, centerY, mainRect, bottomReserved, margin);

        // 9) sæt
        assocEl.style.left = box.x + 'px';
        assocEl.style.top = box.y + 'px';

        // 10) gem denne
        placed.push(box);

        // klik på boblen = create/select derived
        assocEl.addEventListener('click', () => {
          createOrSelectDerived(web.id, assocTitle);
        });
      });

      // ===== helpers inside renderWeb =====
      function resolveCollisions(box, placed, cx, cy, mainRect, bottomReserved, margin) {
        const maxAttempts = 12;
        let attempts = 0;
        while (attempts < maxAttempts && overlapsAny(box, placed)) {
          attempts++;
          const boxCenterX = box.x + box.w / 2;
          const boxCenterY = box.y + box.h / 2;
          const dx = boxCenterX - cx;
          const dy = boxCenterY - cy;
          const len = Math.sqrt(dx*dx + dy*dy) || 1;
          const step = 10;
          box.x += (dx / len) * step;
          box.y += (dy / len) * step;

          // clamp
          if (box.x < margin) box.x = margin;
          if (box.y < margin) box.y = margin;
          if (box.x + box.w > mainRect.width - margin) {
            box.x = mainRect.width - margin - box.w;
          }
          if (box.y + box.h > mainRect.height - margin - bottomReserved) {
            box.y = mainRect.height - margin - bottomReserved - box.h;
          }
        }
      }

      function overlapsAny(box, list) {
        for (const other of list) {
          if (rectsOverlap(box, other)) return true;
        }
        return false;
      }

      function rectsOverlap(a, b) {
        return !(
          a.x + a.w <= b.x ||
          a.x >= b.x + b.w ||
          a.y + a.h <= b.y ||
          a.y >= b.y + b.h
        );
      }
    }

    function createOrSelectDerived(parentId, title) {
      const existing = webs.find(w => w.title.toLowerCase() === title.toLowerCase());
      if (existing) {
        selectedWebId = existing.id;
        visualizedWebId = existing.id;
        centerOverrideId = null;
      } else {
        const newWeb = {
          id: makeId(),
          title,
          associations: [],
          derivedFrom: parentId
        };
        webs.push(newWeb);
        selectedWebId = newWeb.id;
        visualizedWebId = newWeb.id;
        centerOverrideId = null;
      }
      saveToStorage();
      renderAll();
    }

    function deleteWeb(id) {
      webs = webs.filter(w => w.id !== id);
      if (selectedWebId === id) {
        selectedWebId = webs.length ? webs[0].id : null;
        visualizedWebId = selectedWebId;
        centerOverrideId = null;
      }
      saveToStorage();
      renderAll();
    }

    function generateMarkdown(webs) {
      let md = '';
      webs.forEach(w => {
        md += '# ' + w.title + '\n\n';
        if (w.associations.length) {
          w.associations.forEach(a => {
            const derived = webs.find(x => x.title.toLowerCase() === a.toLowerCase());
            md += '- ' + a + (derived ? ' *' : '') + '\n';
          });
        } else {
          md += '_Ingen associationer endnu_ \n';
        }
        md += '\n';
      });
      return md;
    }

    function saveToStorage() {
      const data = { webs, selectedWebId, visualizedWebId, centerOverrideId };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function loadFromStorage() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        return {
          webs: [],
          selectedWebId: null,
          visualizedWebId: null,
          centerOverrideId: null
        };
      }
      try {
        const data = JSON.parse(raw);
        return {
          webs: Array.isArray(data.webs) ? data.webs : [],
          selectedWebId: data.selectedWebId || null,
          visualizedWebId: data.visualizedWebId || (data.selectedWebId || null),
          centerOverrideId: data.centerOverrideId || null
        };
      } catch (e) {
        return {
          webs: [],
          selectedWebId: null,
          visualizedWebId: null,
          centerOverrideId: null
        };
      }
    }

    function makeId() {
      return (crypto.randomUUID ? crypto.randomUUID() : 'id-' + Date.now());
    }

    function getWebById(id) {
      return webs.find(w => w.id === id);
    }

    // init
    renderAll();
  </script>
</body>
</html>
